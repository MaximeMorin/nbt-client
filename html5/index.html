<!DOCTYPE html>
<html>
<head>
<meta charset="ISO-8859-1">
<script src="js/jquery-2.1.1.js"></script>
<script src="js/jquery-ui-1.10.4.js"></script>
<script src="js/nbt/v1.0/login.js"></script>
<script src="js/nbt/v1.0/nbt.js"></script>
<link href="css/nbt.css" rel="stylesheet" />
<title>NetBattleTech Automation</title>
</head>
<body>

<!--  header area (top)  -->
<div>
	<div id="loginBox"></div>
</div>

<!--  body area (middle) -->
<div>
	<!--  left side -->
	<div class="left_side">
		<div id="leagueListBox" >
			<div>Leagues:</div>
			<select id="lstLeagues" onchange="changeCurrentLeague(this);">
				<option>Select League...</option>
			</select>
		</div>
		<div><span class="pseudo_link" onclick="listUnits()">Units</span></div>
	</div>

	<!--  content area -->
	<div class="content_area" id="main_contents">
	</div>
</div>

<!--  footer area (bottom) -->
<div>
</div>

<div id="unit_detail_template" class="unit_detail" style="display: none;">
<table>
	<tr>
		<td rowspan="8"><img id="detail_tmpl_logo" class="unit_logo_large"></img></td>
		<td class="dark_header">Unit Name:</td>
		<td class="datal" id="detail_tmpl_displayName"></td>
		<td class="dark_header">Short Name:</td>
		<td class="datal" id="detail_tmpl_shortName"></td>
	</tr>
	<tr>
		<td class="dark_header">Unit Type:</td>
		<td class="datal" id="detail_tmpl_type" style="width: 100px;"></td>
		<td class="dark_header">Status:</td>
		<td class="datal" id="detail_tmpl_stat" style="width: 100px;"></td>
	</tr>
	<tr>
		<td class="dark_header">CO:</td>
		<td class="datal" colspan="3" id="detail_tmpl_co"></td>
	</tr>
	<tr>
		<td class="dark_header">XO:</td>
		<td class="datal" colspan="3" id="detail_tmpl_xo"></td>
	</tr>
	<tr>
		<td class="dark_header">WWW:</td>
		<td class="datal" id="detail_tmpl_www"></td>
		<td class="dark_header">Tags:</td>
		<td class="datal" id="detail_tmpl_tags"></td>
	</tr>
	<tr>
		<td class="dark_header" style="height: 56px;">Description:</td>
		<td class="dataj" id="detail_tmpl_description" colspan="3"></td>
	</tr>
	<tr>
		<td class="dark_header">Battles Pending:</td>
		<td class="datal" id="detail_tmpl_battles_pending"></td>
		<td class="dark_header">Planets:</td>
		<td class="datal" id="detail_tmpl_planets"></td>
	</tr>
	<tr>
		<td class="dark_header">Contact:</td>
		<td class="datal" id="detail_tmpl_contact_form"></td>
		<td class="dark_header">Timezone:</td>
		<td class="datal" id="detail_tmpl_tz"></td>
	</tr>
	<tr id="unit_detail_tools">
		<td colspan="5" style="text-align: right;">
			<input type="button" id="cmdDetailDelete" value="Delete"/>
			<input type="button" id="cmdDetailEdit" value="Edit"/>
			<input type="button" id="cmdDetailClose" value="Close"/>
		</td>
	</tr>
</table>
</div>

<div id="unit_detail_editor_template" class="unit_detail" style="display: none;">
<table>
	<tr>
		<td rowspan="8"><img id="edit_tmpl_logo" class="unit_logo_large"></img></td>
		<td class="dark_header">Unit Name:</td>
		<td class="datal"><input type="text" id="edit_tmpl_displayName"/></td>
		<td class="dark_header">Short Name:</td>
		<td class="datal"><input type="text" id="edit_tmpl_shortName"/></td>
	</tr>
	<tr>
		<td class="dark_header">Unit Type:</td>
		<td class="datal" style="width: 100px;"><select id="edit_tmpl_type" ></select></td>
		<td class="dark_header">Status:</td>
		<td class="datal" style="width: 100px;"><select id="edit_tmpl_stat"></select></td>
	</tr>
	<tr>
		<td class="dark_header">CO:</td>
		<td class="datal" colspan="3"><input type="text" id="edit_tmpl_co"/></td>
	</tr>
	<tr>
		<td class="dark_header">XO:</td>
		<td class="datal" colspan="3"><input type="text" id="edit_tmpl_xo"/></td>
	</tr>
	<tr>
		<td class="dark_header">WWW:</td>
		<td class="datal"><input type="text" id="edit_tmpl_www"/></td>
		<td class="dark_header">Tags:</td>
		<td class="datal"><input type="text" id="edit_tmpl_tags"/></td>
	</tr>
	<tr>
		<td class="dark_header" style="height: 56px;">Description:</td>
		<td class="dataj" colspan="3"><textarea id="edit_tmpl_description"></textarea></td>
	</tr>
	<tr>
		<td class="dark_header">Timezone:</td>
		<td class="datal" colspan="3"><select id="edit_tmpl_tz" ></select></td>
	</tr>
	<tr id="unit_detail_tools">
		<td colspan="5" style="text-align: right;">
			<input type="button" id="cmdDetailEditorCancel" value="Cancel"/>
			<input type="button" id="cmdDetailEditorSave" value="Save"/>
		</td>
	</tr>
</table>
</div>

</body>
<script>
initLoginBox($("#loginBox"));
var API = new NBT(token);

//check cookies to see if we saved off a previous league choice
var cookieString = document.cookie;
var cookies = cookieString.split(';');
var needle = "nbt_league=";
for (var i=0; i<cookies.length; ++i) {
	var c = cookies[i].trim();
	if (c.indexOf(needle)==0) {
		API.setLeagueId(c.substring(needle.length, c.length));
		break;
	}
}

var unitListing = null;

var rtn = API.fetchLeagues(
	function(obj) {
		// assume that obj is a list of League objects, with displayName and leagueId props on each
		var lstLeagues = $("#lstLeagues");
		var selectedIdx = 0;
		for (var i=0; i<obj.length; ++i) {
			var opt = $("<option/>");
			opt.val(obj[i].leagueId);
			opt.text(obj[i].displayName);
			
			if (API.leagueId() === obj[i].leagueId)
				selectedIdx = i;
				
			lstLeagues.append(opt);
		}
		
		lstLeagues[0].selectedIndex = selectedIdx + 1;
	},
	function (errText) {
		alert (errText);
	}
);

function changeCurrentLeague(_this) {
	var id = _this.options[_this.selectedIndex].value;
	document.cookie="nbt_league=" + id;
	API.setLeagueId(id);
	
	// TODO: Make selected league name bold?
			
	// TODO: show list of units
}

var collapsedRow = null;
var detailRow = null;
var editingRow = null;
var detailUnit = null;

function onUnitDetailClose() {
	var tmpl = $("#unit_detail_template");
	tmpl.hide();
	$("body").append(tmpl);
	$(detailRow).remove();
	detailRow = null;
	$(collapsedRow).show();
	collapsedRow = null;
	detailUnit = null;
}

function onUnitDetailDelete() {
	// submit data
	var nbtReq = new Object();
	nbtReq.token = token;
	nbtReq.unitDetail = detailUnit;
	var strReq = JSON.stringify(nbtReq);
	
	$.ajax({
		url: NBTCall(location.hostname, leagueId, "unit", detailUnit.id),
		type: "DELETE",
		data: strReq
	}).error(function(msg) {
		alert(msg);
	}).success( function(data) {
		var resp = JSON.parse(data);
		
		if (resp.error) {
			alert(resp.message);
		}
		else {
			// reload the unit listing
			populateUnits(resp.data, resp.canEdit);
		}
	});
}

function onUnitDetailCancel() {
	// hide the edit template, show the detail template
	var detailTmpl = $("#unit_detail_template");
	detailTmpl.show();
	
	var editTmpl = $("#unit_detail_editor_template");
	$("body").append(editTmpl);
	editTmpl.hide();
	
	collapsedRow = null;
	editingRow = null;
	
	$("#cmdUnitDetailEditorCancel").unbind("click", onUnitDetailCancel);
	$("#cmdUnitDetailEditorSave").unbind("click", onUnitDetailSave);
}

function onUnitDetailSave() {
	var unitDetail = new Object();
	
	unitDetail.displayName = $("#unit_detail_editor_display_name").val();
	unitDetail.shortName = $("#unit_detail_editor_short_name").val();
	unitDetail.typeCode = $("#unit_detail_editor_type").val();
	unitDetail.statCode = $("#unit_detail_editor_status").val();
	unitDetail.tz = $("#unit_detail_editor_tz").val();
	unitDetail.co = $("#unit_detail_editor_co").val();
	unitDetail.xo = $("#unit_detail_editor_xo").val();
	unitDetail.tags = $("#unit_detail_editor_tags").val();
	unitDetail.www = $("#unit_detail_editor_www").val();
	
	// submit data
	var nbtReq = new Object();
	nbtReq.token = token;
	nbtReq.unitDetail = unitDetail;
	var strReq = JSON.stringify(nbtReq);
	
	$.ajax({
		url: NBTCall(location.hostname, leagueId, "unit", detailUnit.id),
		type: "PUT",
		data: strReq
	}).error(function(msg) {
		alert(msg);
	}).success( function(data) {
		var resp = JSON.parse(data);
		
		if (resp.error) {
			alert(resp.message);
		}
		else {
			var unitDetail = resp.data;
			
			// update the detail template with new values
			$("#unit_detail_display_name").text(unitDetail.displayName);
			$("#unit_detail_short_name").text(unitDetail.shortName);
			$("#unit_detail_type").text($("#unit_detail_editor_type option:selected").text());
			$("#unit_detail_status").text($("#unit_detail_editor_status option:selected").text());
			$("#unit_detail_tz").text($("#unit_detail_editor_tz option:selected").text());
			$("#unit_detail_co").text(unitDetail.co);
			$("#unit_detail_xo").text(unitDetail.xo);
			$("#unit_detail_tags").text(unitDetail.tags);
			$("#unit_detail_www").text(unitDetail.www);
			
			// and reload the unit listing
			listUnits();
		}
	});
	
	onUnitDetailCancel();
}

function onUnitDetailEdit() {
	editingRow = collapsedRow;
	var unit = detailUnit;
	
	var detailTmpl = $("#unit_detail_template");
	detailTmpl.hide();
	
	$("#cmdUnitDetailEditorCancel").bind("click", onUnitDetailCancel);
	$("#cmdUnitDetailEditorSave").bind("click", onUnitDetailSave);
	
	var editTmpl = $("#unit_detail_editor_template");
	detailTmpl.parent().append(editTmpl);
	editTmpl.show();
	
	$("#unit_detail_editor_display_name").val(unit.displayName);
	$("#unit_detail_editor_short_name").val(unit.shortName);
	
	var lstStatus = $("#unit_detail_editor_status");
	if (lstStatus)
		populateUnitStatus(lstStatus[0], unit.stat);
	
	var lstClass = $("#unit_detail_editor_type");
	if (lstClass)
		populateUnitClass(lstClass[0], unit.type);
	
	var lstTimezone = $("#unit_detail_editor_tz");
	if (lstTimezone)
		populateTimezone(lstTimezone[0], unit.tz);
	
	$("#unit_detail_editor_co").val(unit.co);
	$("#unit_detail_editor_xo").val(unit.xo);
	$("#unit_detail_editor_www").val(unit.www);
	$("#unit_detail_editor_tags").val(unit.tags);
}

function onAddUnitSave() {
	var unitDetail = new Object();
	
	unitDetail.displayName = $("#unit_detail_editor_display_name").val();
	unitDetail.shortName = $("#unit_detail_editor_short_name").val();
	unitDetail.typeCode = $("#unit_detail_editor_type").val();
	unitDetail.statCode = $("#unit_detail_editor_status").val();
	unitDetail.tz = $("#unit_detail_editor_tz").val();
	unitDetail.co = $("#unit_detail_editor_co").val();
	unitDetail.xo = $("#unit_detail_editor_xo").val();
	unitDetail.tags = $("#unit_detail_editor_tags").val();
	unitDetail.www = $("#unit_detail_editor_www").val();
	
	// validate data
	if (unitDetail.displayName.length == 0) {
		alert("Unit name cannot be empty");
		return;
	}
	
	if (unitDetail.shortName.length == 0) {
		alert("Unit short name cannot be empty");
		return;
	}
	
	if (unitDetail.tags.length == 0) {
		alert("Unit tags cannot be empty");
		return;
	}
	
	// submit data
	var nbtReq = new Object();
	nbtReq.token = token;
	nbtReq.unitDetail = unitDetail;
	var strReq = JSON.stringify(nbtReq);
	
	$.ajax({
		url: NBTCall(location.hostname, leagueId, "unit"),
		type: "POST",
		data: strReq
	}).error(function(msg) {
		alert(msg);
	}).success( function(data) {
		var resp = JSON.parse(data);
		
		if (resp.error) {
			alert(resp.message);
		}
		else {
			// reload the unit listing
			listUnits();
		}
	});
}

function onAddUnitCancel() {
	var cmd = $("#cmdNewUnit");
	cmd.show();
	
	var editorTmpl = $("#unit_detail_editor_template");
	editorTmpl.hide();
	
	editingRow = null;

	$("#cmdUnitDetailEditorCancel").unbind("click", onAddUnitCancel);
	$("#cmdUnitDetailEditorSave").unbind("click", onAddUnitSave);
}

function onAddNewUnit() {
	// ignore this if we are currently editing another row; list must be in 
	// default state to add a new unit
	if (editingRow || collapsedRow)
		return;

	var cmd = $("#cmdNewUnit");
	cmd.hide();
	
	var editorTmpl = $("#unit_detail_editor_template");
	cmd.parent().append(editorTmpl);
	editorTmpl.show();
	
	$("#cmdUnitDetailEditorCancel").bind("click", onAddUnitCancel);
	$("#cmdUnitDetailEditorSave").bind("click", onAddUnitSave);
	
	var lstStatus = $("#unit_detail_editor_status");
	if (lstStatus)
		populateUnitStatus(lstStatus[0]);
	
	var lstClass = $("#unit_detail_editor_type");
	if (lstClass)
		populateUnitClass(lstClass[0]);
	
	var lstTimezone = $("#unit_detail_editor_tz");
	if (lstTimezone)
		populateTimezone(lstTimezone[0]);
	
	$("#unit_detail_editor_display_name").val("");
	$("#unit_detail_editor_short_name").val("");
	$("#unit_detail_editor_co").val("");
	$("#unit_detail_editor_xo").val("");
	$("#unit_detail_editor_tags").val("");
	$("#unit_detail_editor_www").val("");
	
	editingRow = cmd.parent().parent();
}

function showUnitDetail(unit, canEdit) {
	if (editingRow != null)
		return;
	
	var _row = $("#id_" + unit.id);
	if (_row != null) {
		var row = _row[0];
		
		detailRow = $("<tr/>", {
			class: "no_select"
		});
		
		var td = $("<td/>", {
			colspan: 8,
			style: "text-align: center"
		});
		detailRow.append(td);
		
		var tmpl = $("#unit_detail_template");
		tmpl.show();
		td.append(tmpl);
		
		detailRow.insertAfter(row);
		
		if (collapsedRow != null) {
			$(collapsedRow).show();
			$(collapsedRow).next().remove();
		}
		
		$(row).hide();
		collapsedRow = row;
		
		$("#unit_detail_display_name").text(unit.displayName);
		$("#unit_detail_short_name").text(unit.shortName);
		$("#unit_detail_type").text(unit.type);
		$("#unit_detail_status").text(unit.stat);
		$("#unit_detail_co").text(unit.co);
		$("#unit_detail_xo").text(unit.xo);
		$("#unit_detail_www").text(unit.www);
		$("#unit_detail_tags").text(unit.tags);
		$("#unit_detail_tz").text(unit.tz);
		$("#unit_detail_battles_pending").text(unit.battlesPending);
		$("#unit_detail_planets").text(unit.planets);
		
		detailUnit = unit;
		
		if (!canEdit) {
			$("#cmdUnitDetailEdit").hide();
		}
	}
}

//'data' will be an array of Unit objects
function populateUnits(data, canEdit) {
	var body = $("#main_contents");
	body.empty();
	
	var headers = {
			displayName: new HeaderElement("Name", true), 
			co:          new HeaderElement("Commanding Officer"), 
			xo:          new HeaderElement("Executive Officer"), 
			type:        new HeaderElement("Class", true, true, populateUnitClass), 
			stat:        new HeaderElement("Status", true, true, populateUnitStatus), 
			www:         new HeaderElement("WWW"), 
			tags:        new HeaderElement("Tags"), 
			tz:          new HeaderElement("Timezone", true, true, populateTimezone)
	};
	
	unitListing = new EditableTable(
			body, 
			$("#unit_detail_template")[0], 
			$("#unit_detail_editor_template")[0], 
			data, 
			headers);
	
	unitListing.setEditable(canEdit);
	unitListing.show();
	
/* 	createEditableTable(
		body,
		data,
		headers,
		function() {
			if (editingRow) return;
			
			var id = this["id"].split("_");
			var strToken = JSON.stringify(token);
			
			$.ajax({
				url: API.call(location.hostname, leagueId, "unit", id[1]),
				type: "GET",
				data: strToken
			}).error(function(msg) {
				alert(msg);
			}).success( function(data) {
				var resp = JSON.parse(data);
				showUnitDetail(resp.data[0], resp.canEdit);
			});
		},
		onAddNewUnit,
		canEdit);
	
	collapsedRow = null;
	editingRow = null;
	detailRow = null; */
}

function listUnits() {
	var rtn = API.fetchUnits(
		populateUnits,
		function(errMsg) {
			alert(errMsg);
		}
	);
}

function populateUnitStatus(lstStatus, selected) {
	var strToken = JSON.stringify(token);

	$.ajax({
		url: API.call(location.hostname, "system", "unitStatus"),
		type: "GET",
		data: strToken
	}).error(function(msg) {
		alert(msg);
	}).success( function(data) {
		$(lstStatus).empty();
		var resp = JSON.parse(data);
		$.each(resp.data, function(i, item) {
			var opt = $("<option/>", {
				value: item.key,
				text: item.value
			});
			
			if (item.value === selected)
				opt.prop('selected', true);
			
			$(lstStatus).append(opt);
		});
	});
}

function populateUnitClass(lstClass, selected) {
	var strToken = JSON.stringify(token);

	$.ajax({
		url: API.call(location.hostname, "system", "unitClass"),
		type: "GET",
		data: strToken
	}).error(function(msg) {
		alert(msg);
	}).success( function(data) {
		$(lstClass).empty();
		var resp = JSON.parse(data);
		$.each(resp.data, function(i, item) {
			var opt = $("<option/>", {
				value: item.key,
				text: item.value
			});
			
			if (item.value === selected)
				opt.prop('selected', true);
			
			$(lstClass).append(opt);
		});
	});
}

function populateTimezone(lstTimezone, selected) {
	var strToken = JSON.stringify(token);

	$.ajax({
		url: API.call(location.hostname, "system", "timezone"),
		type: "GET",
		data: strToken
	}).error(function(msg) {
		alert(msg);
	}).success( function(data) {
		$(lstTimezone).empty();
		var resp = JSON.parse(data);
		$.each(resp.data, function(i, item) {
			var opt = $("<option/>", {
				value: item.key,
				text: item.value
			});
			
			if (item.value === selected)
				opt.prop('selected', true);
			
			$(lstTimezone).append(opt);
		});
	});
}

</script>
</html>