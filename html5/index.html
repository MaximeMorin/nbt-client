<!DOCTYPE html>
<html>
<head>
<meta charset="ISO-8859-1">
<script src="js/jquery-2.1.1.js"></script>
<script src="js/jquery-ui-1.10.4.js"></script>
<script src="js/nbt/v1.0/login.js"></script>
<script src="js/nbt/v1.0/nbt.js"></script>
<link href="css/nbt.css" rel="stylesheet" />
<title>NetBattleTech Automation</title>
</head>
<body>

<!--  header area (top)  -->
<div>
	<div id="loginBox"></div>
</div>

<!--  body area (middle) -->
<div>
	<!--  left side -->
	<div class="left_side">
		<div id="leagueListBox" >
			<div>Leagues:</div>
			<select id="lstLeagues" onchange="changeCurrentLeague(this);">
				<option>Select League...</option>
			</select>
		</div>
		<div><span class="pseudo_link" onclick="listUnits()">Units</span></div>
		<div><span class="pseudo_link" onclick="listUsers()">Members</span></div>
	</div>

	<!--  content area -->
	<div class="content_area" id="main_contents">
	</div>
</div>

<!--  footer area (bottom) -->
<div>
</div>

<div id="unit_detail_template" class="unit_detail" style="display: none;">
<table>
	<tr>
		<td rowspan="8"><img id="detail_tmpl_logo" class="unit_logo_large"></img></td>
		<td class="dark_header">Unit Name:</td>
		<td class="datal" id="detail_tmpl_displayName"></td>
		<td class="dark_header">Short Name:</td>
		<td class="datal" id="detail_tmpl_shortName"></td>
	</tr>
	<tr>
		<td class="dark_header">Unit Type:</td>
		<td class="datal" id="detail_tmpl_type" style="width: 100px;"></td>
		<td class="dark_header">Status:</td>
		<td class="datal" id="detail_tmpl_stat" style="width: 100px;"></td>
	</tr>
	<tr>
		<td class="dark_header">CO:</td>
		<td class="datal" colspan="3" id="detail_tmpl_co"></td>
	</tr>
	<tr>
		<td class="dark_header">XO:</td>
		<td class="datal" colspan="3" id="detail_tmpl_xo"></td>
	</tr>
	<tr>
		<td class="dark_header">WWW:</td>
		<td class="datal" id="detail_tmpl_www"></td>
		<td class="dark_header">Tags:</td>
		<td class="datal" id="detail_tmpl_tags"></td>
	</tr>
	<tr>
		<td class="dark_header" style="height: 56px;">Description:</td>
		<td class="dataj" id="detail_tmpl_description" colspan="3"></td>
	</tr>
	<tr>
		<td class="dark_header">Battles Pending:</td>
		<td class="datal" id="detail_tmpl_battles_pending"></td>
		<td class="dark_header">Planets:</td>
		<td class="datal" id="detail_tmpl_planets"></td>
	</tr>
	<tr>
		<td class="dark_header">Contact:</td>
		<td class="datal" id="detail_tmpl_contact_form"></td>
		<td class="dark_header">Timezone:</td>
		<td class="datal" id="detail_tmpl_tz"></td>
	</tr>
	<tr id="unit_detail_tools">
		<td colspan="5" style="text-align: right;">
			<input type="button" id="cmdDetailDelete" value="Delete"/>
			<input type="button" id="cmdDetailEdit" value="Edit"/>
			<input type="button" id="cmdDetailClose" value="Close"/>
		</td>
	</tr>
</table>
</div>

<div id="unit_detail_editor_template" class="unit_detail" style="display: none;">
<table>
	<tr>
		<td rowspan="8"><img id="edit_tmpl_logo" class="unit_logo_large"></img></td>
		<td class="dark_header">Unit Name:</td>
		<td class="datal"><input type="text" id="edit_tmpl_displayName"/></td>
		<td class="dark_header">Short Name:</td>
		<td class="datal"><input type="text" id="edit_tmpl_shortName"/></td>
	</tr>
	<tr>
		<td class="dark_header">Unit Type:</td>
		<td class="datal" style="width: 100px;"><select id="edit_tmpl_type" ></select></td>
		<td class="dark_header">Status:</td>
		<td class="datal" style="width: 100px;"><select id="edit_tmpl_stat"></select></td>
	</tr>
	<tr>
		<td class="dark_header">CO:</td>
		<td class="datal" colspan="3"><input type="text" id="edit_tmpl_co"/></td>
	</tr>
	<tr>
		<td class="dark_header">XO:</td>
		<td class="datal" colspan="3"><input type="text" id="edit_tmpl_xo"/></td>
	</tr>
	<tr>
		<td class="dark_header">WWW:</td>
		<td class="datal"><input type="text" id="edit_tmpl_www"/></td>
		<td class="dark_header">Tags:</td>
		<td class="datal"><input type="text" id="edit_tmpl_tags"/></td>
	</tr>
	<tr>
		<td class="dark_header" style="height: 56px;">Description:</td>
		<td class="dataj" colspan="3"><textarea id="edit_tmpl_description"></textarea></td>
	</tr>
	<tr>
		<td class="dark_header">Timezone:</td>
		<td class="datal" colspan="3"><select id="edit_tmpl_tz" ></select></td>
	</tr>
	<tr id="unit_detail_tools">
		<td colspan="5" style="text-align: right;">
			<input type="button" id="cmdDetailEditorCancel" value="Cancel"/>
			<input type="button" id="cmdDetailEditorSave" value="Save"/>
		</td>
	</tr>
</table>
</div>

<div id="user_detail_template" class="unit_detail" style="display: none;">
<table>
	<tr>
		<td class="dark_header">Login:</td>
		<td class="datal" colspan="3" id="detail_tmpl_login"></td>
	</tr>
	<tr>
		<td class="dark_header">Display Name:</td>
		<td class="datal" id="detail_tmpl_displayName" style="width: 100px;"></td>
		<td class="dark_header">Status:</td>
		<td class="datal" id="detail_tmpl_status" style="width: 100px;"></td>
	</tr>
	<tr>
		<td class="dark_header">Email:</td>
		<td class="datal" colspan="3" id="detail_tmpl_email"></td>
	</tr>
	<tr id="unit_detail_tools">
		<td colspan="4" style="text-align: right;">
			<input type="button" id="cmdDetailDelete" value="Delete"/>
			<input type="button" id="cmdDetailEdit" value="Edit"/>
			<input type="button" id="cmdDetailClose" value="Close"/>
		</td>
	</tr>
</table>
</div>

<div id="user_detail_editor_template" class="unit_detail" style="display: none;">
<table>
	<tr>
		<td class="dark_header">Login:</td>
		<td class="datal" colspan="3"><input type="text" id="edit_tmpl_login"/></td>
	</tr>
	<tr>
		<td class="dark_header">Display Name:</td>
		<td class="datal" colspan="3"><input type="text" id="edit_tmpl_displayName"/></td>
		<td class="dark_header">Status:</td>
		<td class="datal" style="width: 100px;"><select id="edit_tmpl_status"></select></td>
	</tr>
	<tr>
		<td class="dark_header">Email:</td>
		<td class="datal" colspan="3"><input type="text" id="edit_tmpl_email"/></td>
	</tr>
	<tr id="unit_detail_tools">
		<td colspan="5" style="text-align: right;">
			<input type="button" id="cmdDetailEditorCancel" value="Cancel"/>
			<input type="button" id="cmdDetailEditorSave" value="Save"/>
		</td>
	</tr>
</table>
</div>

</body>
<script>
initLoginBox($("#loginBox"));
var API = new NBT(token);

//check cookies to see if we saved off a previous league choice
var cookieString = document.cookie;
var cookies = cookieString.split(';');
var needle = "nbt_league=";
for (var i=0; i<cookies.length; ++i) {
	var c = cookies[i].trim();
	if (c.indexOf(needle)==0) {
		API.setLeagueId(c.substring(needle.length, c.length));
		break;
	}
}

var unitListing = null;
var userListing = null;

var rtn = API.fetchLeagues(
	function(obj) {
		// assume that obj is a list of League objects, with displayName and leagueId props on each
		var lstLeagues = $("#lstLeagues");
		var selectedIdx = 0;
		for (var i=0; i<obj.length; ++i) {
			var opt = $("<option/>");
			opt.val(obj[i].leagueId);
			opt.text(obj[i].displayName);
			
			if (API.leagueId() === obj[i].leagueId)
				selectedIdx = i;
				
			lstLeagues.append(opt);
		}
		
		lstLeagues[0].selectedIndex = selectedIdx + 1;
	},
	function (errText) {
		alert (errText);
	}
);

function changeCurrentLeague(_this) {
	var id = _this.options[_this.selectedIndex].value;
	document.cookie="nbt_league=" + id;
	API.setLeagueId(id);
	
	// TODO: Make selected league name bold?
			
	// TODO: show list of units
}

function onUnitSave(table, unitDetail) {
	// submit data
	var nbtReq = new Object();
	nbtReq.token = API.token();
	nbtReq.unitDetail = unitDetail;
	var strReq = JSON.stringify(nbtReq);
	
	// check unit ID; if it exists, we are doing an update (PUT), 
	// if not, we are doing an add (POST)
	var type = "PUT";
	if (!unitDetail.id)
		type = "POST";
	
	$.ajax({
		url: API.call(location.hostname, API.leagueId(), "unit", unitDetail.id),
		type: type,
		data: strReq
	}).error(function(msg) {
		table.onSaveFailed(unitDetail, msg);
	}).success( function(data) {
		var resp = JSON.parse(data);
		
		if (resp.error) {
			table.onSaveFailed(resp.message);
		}
		else {
			table.onSaveSucceeded(table, resp.data);
		}
	});
}

function onUnitDelete(table, unitDetail) {
	// submit data
	var nbtReq = new Object();
	nbtReq.token = API.token();
	nbtReq.unitDetail = unitDetail;
	var strReq = JSON.stringify(nbtReq);
	
	$.ajax({
		url: API.call(location.hostname, API.leagueId(), "unit", unitDetail.id),
		type: "DELETE",
		data: strReq
	}).error(function(msg) {
		table.onDeleteFailed(unitDetail, resp.message);
	}).success( function(data) {
		var resp = JSON.parse(data);
		
		if (resp.error) {
			table.onDeleteFailed(resp.message);
		}
		else {
			table.onDeleteSucceeded(table, resp.data);
		}
	});
}

function onUserSave(table, user) {
	// submit data
	var nbtReq = new Object();
	nbtReq.token = API.token();
	nbtReq.user = user;
	var strReq = JSON.stringify(nbtReq);
	
	// check unit ID; if it exists, we are doing an update (PUT), 
	// if not, we are doing an add (POST)
	var type = "PUT";
	if (!user.id)
		type = "POST";
	
	$.ajax({
		url: API.call(location.hostname, "security", "user", user.id),
		type: type,
		data: strReq
	}).error(function(msg) {
		table.onSaveFailed(user, msg);
	}).success( function(data) {
		var resp = JSON.parse(data);
		
		if (resp.error) {
			table.onSaveFailed(resp.message);
		}
		else {
			table.onSaveSucceeded(table, resp.data);
		}
	});
}

function onUserDelete(table, userDetail) {
	
}

//'data' will be an array of Unit objects
function populateUnits(data, canEdit) {
	var body = $("#main_contents");
	body.empty();
	
	var headers = {
			displayName: new HeaderElement("Name", true), 
			co:          new HeaderElement("Commanding Officer"), 
			xo:          new HeaderElement("Executive Officer"), 
			type:        new HeaderElement("Class", true, true, populateUnitClass), 
			stat:        new HeaderElement("Status", true, true, populateUnitStatus), 
			www:         new HeaderElement("WWW"), 
			tags:        new HeaderElement("Tags"), 
			tz:          new HeaderElement("Timezone", true, true, populateTimezone)
	};
	
	if (unitListing) {
		unitListing.clear();
	}
	
	unitListing = new EditableTable(
			API.token(),
			body, 
			$("#unit_detail_template")[0], 
			$("#unit_detail_editor_template")[0], 
			data, 
			headers,
			onUnitSave,
			onUnitDelete);
	
	unitListing.setEditable(canEdit);
	unitListing.show();
}

function listUnits() {
	var rtn = API.fetchUnits(
		populateUnits,
		function(errMsg) {
			alert(errMsg);
		}
	);
}


//'data' will be an array of Unit objects
function populateUsers(data, canEdit) {
	var body = $("#main_contents");
	body.empty();
	
	var headers = {
			login:       new HeaderElement("Login", true), 
			displayName: new HeaderElement("Name", true), 
			status:      new HeaderElement("Status", true, true, populateUserStatus), 
			email:       new HeaderElement("Email"), 
	};
	
	if (userListing) {
		userListing.clear();
	}
	
	userListing = new EditableTable(
			API.token(),
			body, 
			$("#user_detail_template")[0], 
			$("#user_detail_editor_template")[0], 
			data, 
			headers,
			onUserSave,
			onUserDelete);
	
	userListing.setEditable(canEdit);
	userListing.show();
}

function listUsers() {
	var rtn = API.fetchUsers(
		populateUsers,
		function(errMsg) {
			alert(errMsg);
		}
	);
}

</script>
</html>